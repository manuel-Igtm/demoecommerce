pipeline {
    agent any
    
    stages {
        stage('Checkout and Setup') {
            steps {
                checkout scm
                sh '''
                    echo "=== Git Information ==="
                    git status
                    git branch -a
                    echo "=== Project Structure ==="
                    ls -la
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    cd ecommerce
                    # Install system Python packages if needed
                    apt-get update && apt-get install -y python3 python3-pip python3-venv 2>/dev/null || true
                    
                    # Create virtual environment
                    python3 -m venv venv || echo "Virtual environment creation failed, using system Python"
                    
                    # Install dependencies
                    if [ -f "venv/bin/pip" ]; then
                        venv/bin/pip install --upgrade pip
                        venv/bin/pip install -r requirements.txt
                    else
                        pip3 install --upgrade pip
                        pip3 install -r requirements.txt
                    fi
                '''
            }
        }
        
        stage('Run Django Checks') {
            steps {
                sh '''
                    cd ecommerce
                    # Use virtual environment if available
                    if [ -f "venv/bin/python" ]; then
                        venv/bin/python manage.py check
                        venv/bin/python manage.py test --verbosity=2
                    else
                        python3 manage.py check
                        python3 manage.py test --verbosity=2
                    fi
                '''
            }
        }
    }
    
    post {
        always {
            echo "Pipeline completed"
        }
    }
}